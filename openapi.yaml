openapi: 3.0.3
info:
  title: Grove API
  description: |
    REST API for Grove — a markdown-first daily note taker and personal knowledge management app.
    Vaults are stored under `~/.grove/vaults/`. Each vault has its own notes, templates, contacts, and config.
  version: 1.0.0
  license:
    name: MIT

servers:
  - url: http://localhost:5000
    description: Local development

tags:
  - name: Notes
    description: Create, read, update, delete notes
  - name: Folders
    description: Create, move, rename, delete folders
  - name: Search & Tags
    description: Search notes and manage tags
  - name: Graph & Links
    description: Wikilink graph, backlinks, and wikilink resolution map
  - name: Calendar
    description: Calendar view of dated notes
  - name: Templates
    description: Manage note templates
  - name: Daily & Meeting
    description: Quick-create daily and meeting notes
  - name: Todos
    description: Checkbox/todo tracking across vault
  - name: Contacts
    description: Contact management and @ mention support
  - name: Vaults
    description: Multi-vault management
  - name: Config
    description: Per-vault configuration
  - name: Files & Images
    description: File uploads, serving, and attachments
  - name: Export
    description: JSONL/JSON export for LLM pipelines
  - name: LLM
    description: Optional LLM integration for AI-assisted writing
paths:
  /api/tree:
    get:
      tags: [Notes]
      summary: Get vault directory tree
      description: Returns the full file tree of the active vault, including folders, markdown files, and asset files.
      responses:
        '200':
          description: Directory tree
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TreeItem'

  /api/note/{path}:
    get:
      tags: [Notes]
      summary: Get a note
      parameters:
        - $ref: '#/components/parameters/NotePath'
      responses:
        '200':
          description: Note content and metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
        '404':
          description: Note not found
    put:
      tags: [Notes]
      summary: Save a note
      description: Save note content. Automatically adds `updated` timestamp in frontmatter.
      parameters:
        - $ref: '#/components/parameters/NotePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  description: Full note content including frontmatter
      responses:
        '200':
          description: Note saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'
    delete:
      tags: [Notes]
      summary: Delete a note
      parameters:
        - $ref: '#/components/parameters/NotePath'
      responses:
        '200':
          description: Note deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '404':
          description: Note not found

  /api/note:
    post:
      tags: [Notes]
      summary: Create a new note
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  default: Untitled
                tags:
                  type: array
                  items:
                    type: string
                folder:
                  type: string
                  description: Target folder path
                template:
                  type: string
                  description: Template name to use (e.g., meeting, decision)
                filename:
                  type: string
                  description: Custom filename (without .md extension)
      responses:
        '200':
          description: Note created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/note/{path}/tags:
    put:
      tags: [Notes]
      summary: Update note tags
      parameters:
        - $ref: '#/components/parameters/NotePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Tags updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/note/{path}/star:
    post:
      tags: [Notes]
      summary: Toggle star status of a note
      description: Toggles the `starred` field in frontmatter between true and false
      parameters:
        - $ref: '#/components/parameters/NotePath'
      responses:
        '200':
          description: Star status toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  starred:
                    type: boolean
                    description: New starred status
        '404':
          description: Note not found

  /api/note/{path}/rename:
    put:
      tags: [Notes]
      summary: Rename a note
      parameters:
        - $ref: '#/components/parameters/NotePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Note renamed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/folder:
    post:
      tags: [Folders]
      summary: Create a new folder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                parent:
                  type: string
                  description: Parent folder path
      responses:
        '200':
          description: Folder created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/move:
    post:
      tags: [Folders]
      summary: Move a file to a different folder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source]
              properties:
                source:
                  type: string
                  description: Source file path
                target:
                  type: string
                  description: Target folder path (empty string for root)
      responses:
        '200':
          description: File moved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/move-folder:
    post:
      tags: [Folders]
      summary: Move a folder to another location
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source]
              properties:
                source:
                  type: string
                target:
                  type: string
      responses:
        '200':
          description: Folder moved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/rename:
    post:
      tags: [Folders]
      summary: Rename a file
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [old_path, new_name]
              properties:
                old_path:
                  type: string
                new_name:
                  type: string
      responses:
        '200':
          description: File renamed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/daily:
    post:
      tags: [Daily & Meeting]
      summary: Create today's daily note
      description: |
        Creates a daily note at `daily/YYYY-MM-DD.md` using the `daily` template if available.
        If the note already exists, returns the existing path.
      responses:
        '200':
          description: Daily note created or found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessPath'

  /api/search:
    get:
      tags: [Search & Tags]
      summary: Search notes
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: Search query (matches title and content)
        - name: tag
          in: query
          schema:
            type: string
          description: Filter by tag
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    path:
                      type: string
                    title:
                      type: string
                    tags:
                      type: array
                      items:
                        type: string

  /api/tags:
    get:
      tags: [Search & Tags]
      summary: Get all tags with counts
      responses:
        '200':
          description: Tag name to count mapping
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: integer

  /api/templates:
    get:
      tags: [Templates]
      summary: List all templates
      responses:
        '200':
          description: List of templates
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    path:
                      type: string

  /api/template:
    post:
      tags: [Templates]
      summary: Create a new template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                content:
                  type: string
      responses:
        '200':
          description: Template created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  name:
                    type: string

  /api/template/{name}:
    get:
      tags: [Templates]
      summary: Get a template
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template content
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  content:
                    type: string
        '404':
          description: Template not found
    put:
      tags: [Templates]
      summary: Update a template
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
      responses:
        '200':
          description: Template updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
    delete:
      tags: [Templates]
      summary: Delete a template
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/todos:
    get:
      tags: [Todos]
      summary: Get all todos across vault
      description: Scans all notes for checkbox items (`- [ ]` and `- [x]`).
      responses:
        '200':
          description: List of todos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TodoItem'

  /api/toggle-todo:
    post:
      tags: [Todos]
      summary: Toggle a checkbox
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [path, line]
              properties:
                path:
                  type: string
                  description: Note path
                line:
                  type: integer
                  description: Line number (0-indexed)
      responses:
        '200':
          description: Checkbox toggled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/contacts:
    get:
      tags: [Contacts]
      summary: List all contacts
      responses:
        '200':
          description: Contact list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contact'
    post:
      tags: [Contacts]
      summary: Add a contact
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactInput'
      responses:
        '200':
          description: Contact added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  contact:
                    $ref: '#/components/schemas/Contact'

  /api/contacts/{id}:
    put:
      tags: [Contacts]
      summary: Update a contact
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactInput'
      responses:
        '200':
          description: Contact updated
        '404':
          description: Contact not found
    delete:
      tags: [Contacts]
      summary: Delete a contact
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contact deleted
        '404':
          description: Contact not found

  /api/contacts/import:
    post:
      tags: [Contacts]
      summary: Bulk import contacts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ContactInput'
      responses:
        '200':
          description: Import results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  added:
                    type: integer
                  total:
                    type: integer

  /api/vaults:
    get:
      tags: [Vaults]
      summary: List vaults and active vault
      responses:
        '200':
          description: Vault list
          content:
            application/json:
              schema:
                type: object
                properties:
                  active:
                    type: string
                  vaults:
                    type: array
                    items:
                      type: string

  /api/vaults/create:
    post:
      tags: [Vaults]
      summary: Create a new vault
      description: Creates a vault under `~/.grove/vaults/` and seeds it with templates and README.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Vault created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/vaults/switch:
    post:
      tags: [Vaults]
      summary: Switch active vault
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Vault switched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/vaults/delete:
    post:
      tags: [Vaults]
      summary: Delete a vault
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Vault deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /api/vaults/export:
    get:
      tags: [Vaults]
      summary: Export active vault as ZIP
      responses:
        '200':
          description: ZIP file download
          content:
            application/zip:
              schema:
                type: string
                format: binary

  /api/config:
    get:
      tags: [Config]
      summary: Get per-vault config
      responses:
        '200':
          description: Vault configuration
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
    put:
      tags: [Config]
      summary: Update per-vault config
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Config updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  config:
                    type: object

  /api/file/{path}:
    get:
      tags: [Files & Images]
      summary: Serve a file from the vault
      description: Serves any file (images, PDFs, etc.) with path-traversal protection.
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: File content
        '403':
          description: Access denied (path traversal)
        '404':
          description: File not found

  /api/upload:
    post:
      tags: [Files & Images]
      summary: Upload a file
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                folder:
                  type: string
                  default: attachments
      responses:
        '200':
          description: File uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'

  /api/upload/paste:
    post:
      tags: [Files & Images]
      summary: Upload pasted image (base64)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [data]
              properties:
                data:
                  type: string
                  description: Base64 encoded image data (with or without data URL prefix)
                filename:
                  type: string
                  default: paste-{uuid}.png
                folder:
                  type: string
                  default: attachments
      responses:
        '200':
          description: Image uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'

  /api/export:
    get:
      tags: [Export]
      summary: Export vault notes
      description: |
        Export all notes from the active vault as JSONL or JSON.
        Supports incremental export via the `since` parameter.
        Each note includes path, title, type, tags, created, modified, and body.
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [jsonl, json]
            default: jsonl
          description: Output format
        - name: since
          in: query
          schema:
            type: string
            format: date-time
          description: ISO timestamp — only export notes modified after this time
      responses:
        '200':
          description: Exported notes
          content:
            application/x-ndjson:
              schema:
                type: string
                description: One JSON object per line (JSONL format)
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExportNote'

  /api/extract:
    get:
      tags: [Export]
      summary: Extract notes as markdown
      description: |
        Extract notes based on time range, starred status, type, and tags.
        Returns concatenated markdown with metadata headers per note.
        Time matching: note matches if EITHER created OR updated falls within range.
      parameters:
        - name: months
          in: query
          schema:
            type: string
            enum: ["1", "3", "6", "12", "all"]
            default: "all"
          description: Time range - number of months or "all" for all time
        - name: starred
          in: query
          schema:
            type: string
            enum: ["true", "false"]
            default: "true"
          description: Filter by starred status
        - name: type
          in: query
          schema:
            type: string
          description: Comma-separated note types to filter (e.g., "meeting,decision,research")
        - name: tag
          in: query
          schema:
            type: string
          description: Tag to filter by
      responses:
        '200':
          description: Extracted notes as markdown
          content:
            text/markdown:
              schema:
                type: string
                description: Concatenated markdown with headers and metadata

  /api/folder/{path}:
    delete:
      tags: [Folders]
      summary: Delete a folder
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Folder path relative to vault root
      responses:
        '200':
          description: Folder deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '400':
          description: Folder not empty or invalid path
        '404':
          description: Folder not found

  /api/folders:
    get:
      tags: [Folders]
      summary: List all folders in the vault
      description: Returns a sorted list of all folder paths relative to the vault root, excluding hidden directories.
      responses:
        '200':
          description: List of folder paths
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /api/backlinks/{path}:
    get:
      tags: [Graph & Links]
      summary: Get backlinks for a note
      description: Returns all notes that contain a wikilink pointing to this note (by title, filename, or path).
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Note path relative to vault root
      responses:
        '200':
          description: Backlink results
          content:
            application/json:
              schema:
                type: object
                properties:
                  note:
                    type: string
                  title:
                    type: string
                  backlinks:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        title:
                          type: string
                  count:
                    type: integer
        '404':
          description: Note not found

  /api/wikilink-map:
    get:
      tags: [Graph & Links]
      summary: Get wikilink resolution map
      description: Returns a flat object mapping lowercased titles, filename stems, and paths to their vault-relative file paths. Used for resolving `[[wikilinks]]` to actual notes.
      responses:
        '200':
          description: Title/name to path map
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: string
                description: Keys are lowercased title/filename variants; values are vault-relative paths

  /api/graph:
    get:
      tags: [Graph & Links]
      summary: Get note graph data
      description: Returns all notes as nodes and all wikilink connections as edges for graph visualisation.
      responses:
        '200':
          description: Graph nodes and edges
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: Vault-relative path
                        label:
                          type: string
                        title:
                          type: string
                        tags:
                          type: array
                          items:
                            type: string
                  edges:
                    type: array
                    items:
                      type: object
                      properties:
                        from:
                          type: string
                        to:
                          type: string

  /api/calendar:
    get:
      tags: [Calendar]
      summary: Get calendar data
      description: |
        Returns all notes that have a date (`YYYY-MM-DD`) or week (`YYYY-WNN`) in their filename,
        grouped by date string. Weekly planners are mapped to their Monday date.
      responses:
        '200':
          description: Date-keyed map of notes
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: array
                  items:
                    type: object
                    properties:
                      path:
                        type: string
                      title:
                        type: string
                      type:
                        type: string
                        enum: [daily, meeting, planner, note]

  /api/upload/bulk:
    post:
      tags: [Files & Images]
      summary: Bulk upload files
      description: Upload multiple files to a specified vault folder in a single request.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: One or more files to upload
                folder:
                  type: string
                  description: Target folder path relative to vault root (empty for vault root)
      responses:
        '200':
          description: Upload results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  uploaded:
                    type: array
                    items:
                      type: string
                    description: Paths of successfully uploaded files
                  errors:
                    type: array
                    items:
                      type: string
                    description: Error messages for any failed uploads

  /api/llm/status:
    get:
      tags: [LLM]
      summary: Get LLM configuration status
      description: Returns whether the LLM integration is enabled and configured. Never exposes the API key.
      responses:
        '200':
          description: LLM status
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                    description: Whether GROVE_LLM_ENABLED=true
                  effective:
                    type: boolean
                    description: Whether the LLM is fully configured and usable
                  provider:
                    type: string
                    description: LLM provider (openai, anthropic, ollama, or custom)
                  needs_api_key:
                    type: boolean
                    description: True when provider requires an API key but none is set

  /api/llm:
    post:
      tags: [LLM]
      summary: Generate text via LLM
      description: |
        Sends a prompt (and optional selected text) to the configured LLM and returns the generated text.
        Returns 403 if LLM is disabled or not fully configured.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                prompt:
                  type: string
                  description: Instruction or prompt text
                selection:
                  type: string
                  description: Selected text from the editor to pass as context
      responses:
        '200':
          description: Generated text
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string
                    description: Generated text from the LLM
                  model:
                    type: string
                    description: Model identifier used
        '400':
          description: Missing prompt
        '403':
          description: LLM disabled or not configured

components:
  parameters:
    NotePath:
      name: path
      in: path
      required: true
      schema:
        type: string
      description: Note path relative to vault root (e.g., `daily/2026-02-14.md`)

  schemas:
    Success:
      type: object
      properties:
        success:
          type: boolean

    SuccessPath:
      type: object
      properties:
        success:
          type: boolean
        path:
          type: string

    TreeItem:
      type: object
      properties:
        name:
          type: string
        path:
          type: string
        type:
          type: string
          enum: [file, folder, asset]
        starred:
          type: boolean
          description: Whether the file is starred (only for type=file)
        children:
          type: array
          items:
            $ref: '#/components/schemas/TreeItem'

    NoteResponse:
      type: object
      properties:
        path:
          type: string
        title:
          type: string
        tags:
          type: array
          items:
            type: string
        content:
          type: string
          description: Full content including frontmatter
        body:
          type: string
          description: Body without frontmatter
        starred:
          type: boolean
          description: Whether the note is starred

    TodoItem:
      type: object
      properties:
        note:
          type: string
          description: Note title
        path:
          type: string
        line:
          type: integer
        text:
          type: string
        completed:
          type: boolean
        indent:
          type: integer

    Contact:
      type: object
      properties:
        id:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        title:
          type: string
          description: Job title
        department:
          type: string
        company:
          type: string
        email:
          type: string
        phone:
          type: string
        office_phone:
          type: string
        mobile_phone:
          type: string
        zoom_id:
          type: string
          description: Zoom personal meeting ID or link
        note:
          type: string
          description: Free-form notes about the contact
        profile_id:
          type: string
          description: ID of the contact's profile note (template profile)
        template:
          type: string
          description: Template name used for the contact's note page

    ContactInput:
      type: object
      properties:
        id:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        title:
          type: string
          description: Job title
        department:
          type: string
        company:
          type: string
        email:
          type: string
        phone:
          type: string
        office_phone:
          type: string
        mobile_phone:
          type: string
        zoom_id:
          type: string
          description: Zoom personal meeting ID or link
        note:
          type: string
          description: Free-form notes about the contact
        profile_id:
          type: string
          description: ID of the contact's profile note (template profile)
        template:
          type: string
          description: Template name used for the contact's note page

    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        path:
          type: string
        url:
          type: string
        markdown:
          type: string
          description: Ready-to-use markdown image reference

    ExportNote:
      type: object
      properties:
        path:
          type: string
        title:
          type: string
        type:
          type: string
        tags:
          type: array
          items:
            type: string
        created:
          type: string
        modified:
          type: string
          format: date-time
        body:
          type: string
